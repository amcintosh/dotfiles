#!/usr/bin/env python3
"""
XML Formatter Script

Formats XML files with proper indentation and structure.

Usage:
    python format.py <input_file.xml>
    python format.py <input_file.xml> --output <output_file.xml>
    python format.py <input_file.xml> --indent 4
"""

import argparse
import sys
import xml.dom.minidom as minidom
from pathlib import Path


def format_xml(input_file, output_file=None, indent=2):
    """
    Format an XML file with proper indentation.

    Args:
        input_file: Path to the input XML file
        output_file: Path to the output XML file (defaults to overwriting input)
        indent: Number of spaces for indentation (default: 2)
    """
    try:
        # Read the XML file
        with open(input_file, 'r', encoding='utf-8') as f:
            xml_content = f.read()

        # Parse and pretty-print
        dom = minidom.parseString(xml_content)
        pretty_xml = dom.toprettyxml(indent=' ' * indent, encoding='utf-8')

        # Remove extra blank lines that toprettyxml adds
        lines = pretty_xml.decode('utf-8').split('\n')
        non_empty_lines = [line for line in lines if line.strip()]
        formatted_xml = '\n'.join(non_empty_lines) + '\n'

        # Determine output file
        output_path = output_file if output_file else input_file

        # Write the formatted XML
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(formatted_xml)

        print(f"✓ Successfully formatted XML: {output_path}")
        return True

    except FileNotFoundError:
        print(f"✗ Error: File not found: {input_file}", file=sys.stderr)
        return False
    except Exception as e:
        print(f"✗ Error formatting XML: {e}", file=sys.stderr)
        return False


def main():
    parser = argparse.ArgumentParser(
        description='Format XML files with proper indentation',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python format.py config.xml                    # Format in-place
  python format.py config.xml -o formatted.xml   # Write to new file
  python format.py config.xml --indent 4         # Use 4-space indent
        """
    )

    parser.add_argument(
        'input_file',
        type=str,
        help='Path to the XML file to format'
    )

    parser.add_argument(
        '-o', '--output',
        type=str,
        default=None,
        help='Output file path (default: overwrite input file)'
    )

    parser.add_argument(
        '-i', '--indent',
        type=int,
        default=2,
        help='Number of spaces for indentation (default: 2)'
    )

    args = parser.parse_args()

    # Validate input file exists
    if not Path(args.input_file).exists():
        print(f"✗ Error: File not found: {args.input_file}", file=sys.stderr)
        sys.exit(1)

    # Format the XML
    success = format_xml(args.input_file, args.output, args.indent)

    sys.exit(0 if success else 1)


if __name__ == '__main__':
    main()
